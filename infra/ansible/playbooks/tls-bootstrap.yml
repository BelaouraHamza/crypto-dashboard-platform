- name: Create self-signed TLS cert and kubernetes secret for crypto.local
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Ensure /etc/hosts contains crypto.local
      become: yes
      lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 crypto.local"
        state: present

    - name: Generate private key
      command: openssl genrsa -out crypto.local.key 2048
      args:
        chdir: /tmp
      creates: /tmp/crypto.local.key

    - name: Generate CSR
      command: openssl req -new -key crypto.local.key -out crypto.local.csr -subj "/CN=crypto.local"
      args:
        chdir: /tmp
      creates: /tmp/crypto.local.csr

    - name: Self-sign cert
      command: openssl x509 -req -days 365 -in crypto.local.csr -signkey crypto.local.key -out crypto.local.crt
      args:
        chdir: /tmp
      creates: /tmp/crypto.local.crt

    - name: Create TLS secret in crypto namespace
      command: kubectl -n crypto create secret tls crypto-tls --cert=/tmp/crypto.local.crt --key=/tmp/crypto.local.key
      ignore_errors: yes